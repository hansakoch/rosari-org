---
import Layout from '../layouts/Layout.astro';
import VoicePrompt from '../components/VoicePrompt.astro';
import RosaryBeads from '../components/RosaryBeads.astro';
import KaraokeText from '../components/KaraokeText.astro';
---

<Layout title="Rosari â€” The Holy Rosary" description="Pray the complete Holy Rosary in any language. A reverent, offline-capable Catholic rosary web app. No ads, no tracking, pure prayer.">

  <!-- Voice Prompt Overlay -->
  <VoicePrompt />

  <!-- Main App -->
  <main id="rosary-app" class="rosary-app">

    <!-- Header -->
    <header class="app-header">
      <div class="header-cross" aria-hidden="true">âœ</div>
      <div class="header-center">
        <h1 class="site-title">Rosari</h1>
        <div id="mystery-banner" class="mystery-banner"></div>
      </div>
      <div class="header-controls">
        <button id="theme-toggle" class="ctrl-btn" aria-label="Toggle day/night mode" title="Toggle day/night mode">
          â˜€ï¸ Day
        </button>
        <button id="change-language-btn" class="ctrl-btn" aria-label="Change language" title="Change language">
          ğŸŒ
        </button>
      </div>
    </header>

    <!-- Progress Bar -->
    <div class="progress-container" role="progressbar" aria-label="Rosary progress">
      <div class="progress-bar">
        <div id="progress-bar-inner" class="progress-bar-inner"></div>
      </div>
      <span id="progress-label" class="progress-label">0 / 0</span>
    </div>

    <!-- Rosary Content -->
    <div class="rosary-content">
      <!-- Left/Top: Bead Visualization -->
      <aside class="bead-panel" aria-label="Rosary beads">
        <RosaryBeads />
      </aside>

      <!-- Right/Bottom: Text & Controls -->
      <div class="prayer-panel">
        <KaraokeText />

        <!-- Playback Controls -->
        <div class="playback-controls" role="group" aria-label="Playback controls">
          <button id="prev-btn" class="ctrl-round" aria-label="Previous prayer" title="Previous">
            â®
          </button>
          <button id="play-pause-btn" class="ctrl-main" aria-label="Begin rosary">
            â–¶ Begin
          </button>
          <button id="next-btn" class="ctrl-round" aria-label="Skip prayer" title="Next">
            â­
          </button>
        </div>

        <!-- Bottom actions -->
        <div class="bottom-actions">
          <button id="download-offline-btn" class="action-btn" aria-label="Download rosary for offline use">
            ğŸ“¥ Download for Lent
          </button>
        </div>
      </div>
    </div>

    <!-- Finished Message -->
    <div id="finished-message" class="finished-message" style="display:none;" role="status">
      <div class="finished-cross" aria-hidden="true">âœ</div>
      <p class="finished-text">Praised be Jesus Christ.</p>
      <p class="finished-sub">The Rosary is complete. Go in peace.</p>
      <button id="restart-btn" class="ctrl-main" style="margin-top:1rem;">Pray Again</button>
    </div>

    <!-- Footer -->
    <footer class="app-footer">
      <p>
        <span class="footer-cross" aria-hidden="true">âœ</span>
        Ave Maria, gratia plena
        <span class="footer-cross" aria-hidden="true">âœ</span>
      </p>
      <p class="footer-sub">rosari.org â€” No ads. No tracking. Pure prayer.</p>
    </footer>
  </main>
</Layout>

<!-- Main app script -->
<script>
  import { getMysteryForDate, MYSTERY_SETS, PRAYERS, getBeadPositions, buildRosarySequence } from '../scripts/rosary-data.ts';
  import { RosaryEngine } from '../scripts/rosary-engine.ts';
  import { audioManager, ambientAudio } from '../scripts/audio-manager.ts';
  import { savePreferences, loadPreferences } from '../scripts/storage-manager.ts';
  import { startLanguagePrompt, announcePrompt, parseVoiceInput } from '../scripts/voice-recognition.ts';

  // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let engine: RosaryEngine | null = null;
  let currentLanguageCode = 'en-US';
  let currentLanguage = 'English';
  let currentVoiceDesc = 'elderly rural Piedmontese farmer, gravelly northern Italian drawl, mid-tempo, reverent';
  let isRunning = false;
  let isStopping = false;
  let recognitionController: { stop: () => void } | null = null;

  function el<T extends HTMLElement = HTMLElement>(id: string): T | null {
    return document.getElementById(id) as T | null;
  }

  // â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function applyTheme(theme: 'night' | 'day'): void {
    document.documentElement.setAttribute('data-theme', theme);
    const btn = el('theme-toggle');
    if (btn) btn.textContent = theme === 'night' ? 'â˜€ï¸ Day' : 'ğŸŒ™ Night';
  }

  function detectAutoTheme(): 'night' | 'day' {
    const hour = new Date().getHours();
    return (hour >= 20 || hour < 7) ? 'night' : 'day';
  }

  function applyMysteryTheme(type: string): void {
    document.documentElement.setAttribute('data-mystery', type);
    const set = MYSTERY_SETS[type as keyof typeof MYSTERY_SETS];
    if (set) {
      document.documentElement.style.setProperty('--accent', set.color.primary);
      document.documentElement.style.setProperty('--accent2', set.color.secondary);
      document.documentElement.style.setProperty('--accent-glow', `${set.color.primary}44`);
    }
  }

  // â”€â”€ Voice Prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showVoicePrompt(): void {
    const o = el('voice-prompt-overlay');
    if (o) o.style.display = 'flex';
  }

  function hideVoicePrompt(): void {
    const o = el('voice-prompt-overlay');
    if (o) {
      o.style.opacity = '0';
      o.style.transition = 'opacity 0.6s ease';
      setTimeout(() => { if (o) o.style.display = 'none'; }, 600);
    }
  }

  function updateVoiceStatus(text: string, listening = false): void {
    const s = el('voice-status');
    if (!s) return;
    s.textContent = text;
    s.classList.toggle('listening', listening);
    const ring = el('mic-ring');
    ring?.classList.toggle('listening', listening);
  }

  // â”€â”€ Bead Update â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateBeads(activeBeadIndex: number): void {
    document.querySelectorAll<SVGCircleElement>('.rosary-bead').forEach(bead => {
      const idx = parseInt(bead.dataset['beadIdx'] ?? '-1');
      bead.classList.toggle('active', idx === activeBeadIndex && activeBeadIndex >= 0);
      bead.classList.toggle('prayed', activeBeadIndex >= 0 && idx >= 0 && idx < activeBeadIndex);
    });

    // Decade dots
    if (activeBeadIndex >= 6) {
      const decadeIdx = Math.floor((activeBeadIndex - 6) / 11);
      document.querySelectorAll('.decade-dot').forEach((dot, i) => {
        dot.classList.toggle('active', i === decadeIdx);
        dot.classList.toggle('done', i < decadeIdx);
      });
    }
  }

  // â”€â”€ Karaoke â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateKaraoke(text: string, wordIdx: number, title: string): void {
    const container = el('karaoke-primary');
    if (!container) return;
    const words = text.split(/\s+/);
    container.innerHTML = words
      .map((word, i) => {
        const cls = i === wordIdx ? 'active' : i < wordIdx ? 'prayed' : '';
        return `<span class="karaoke-word${cls ? ' '+cls : ''}" data-idx="${i}">${word}</span>`;
      })
      .join(' ');
    const active = container.querySelector('.karaoke-word.active');
    active?.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'nearest' });

    const titleEl = el('prayer-title');
    if (titleEl) titleEl.textContent = title;
  }

  function updateMysteryDisplay(mysteryName: string, meditationText: string, isMysteryStep: boolean): void {
    const announcement = el('mystery-announcement');
    const nameEl = el('mystery-name');
    const meditationEl = el('mystery-meditation');
    if (announcement) announcement.style.display = isMysteryStep ? 'block' : 'none';
    if (nameEl) nameEl.textContent = mysteryName;
    if (meditationEl) meditationEl.textContent = meditationText;
  }

  function updateProgress(step: number, total: number): void {
    const bar = el('progress-bar-inner');
    const label = el('progress-label');
    if (bar) bar.style.width = `${total > 0 ? (step / total) * 100 : 0}%`;
    if (label) label.textContent = `${step + 1} / ${total}`;
  }

  // â”€â”€ Main State Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderState(state: ReturnType<RosaryEngine['getState']>): void {
    applyMysteryTheme(state.mysteryType);
    updateBeads(state.currentBeadIndex);

    const isMystery = state.currentStep.prayer === 'mysteryAnnounce';
    const text = isMystery
      ? `${state.currentPrayerTitle}. ${state.currentMeditationText}`
      : state.currentPrayerText;

    updateKaraoke(state.currentPrayerText, state.wordIndex, state.currentPrayerTitle);
    updateMysteryDisplay(state.currentMysteryName, state.currentMeditationText, isMystery);
    updateProgress(state.currentStepIndex, state.totalSteps);

    // Banner
    const banner = el('mystery-banner');
    if (banner) banner.textContent = MYSTERY_SETS[state.mysteryType]?.name ?? '';

    // Play/pause button
    const btn = el('play-pause-btn');
    if (btn) {
      btn.textContent = state.engineState === 'playing' ? 'â¸ Pause'
        : state.engineState === 'paused' ? 'â–¶ Resume'
        : 'â–¶ Begin';
    }

    // Language badge
    const badge = el('lang-badge-primary');
    if (badge) badge.textContent = state.language;

    // Finished
    if (state.engineState === 'finished') {
      isRunning = false;
      const msg = el('finished-message');
      if (msg) msg.style.display = 'flex';
    }
  }

  // â”€â”€ Playback Loop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function playNextStep(): Promise<void> {
    if (!engine || !isRunning || isStopping) return;
    const state = engine.getState();
    if (state.engineState !== 'playing') return;

    const step = state.currentStep;
    let text = state.currentPrayerText;

    if (step.prayer === 'mysteryAnnounce') {
      text = `${state.currentPrayerTitle}. ${state.currentMeditationText}`;
    }

    const prayerKey = `${step.prayer}-d${step.decadeIndex ?? 0}-h${step.hailMaryIndex ?? 0}`;

    await audioManager.playStep(
      text,
      {
        text,
        language: currentLanguage,
        languageCode: currentLanguageCode,
        voiceDescription: currentVoiceDesc,
        prayerKey,
      },
      (wordIdx: number) => {
        engine?.setWordIndex(wordIdx);
        renderState(engine!.getState());
      },
      () => {}
    );

    if (!isRunning || isStopping) return;

    // Brief contemplative pause
    const pause = step.prayer === 'mysteryAnnounce' ? 2000
      : step.prayer === 'fatimaPrayer' ? 800
      : step.prayer === 'gloryBe' ? 600
      : 400;

    await new Promise(r => setTimeout(r, pause));

    if (!isRunning || isStopping) return;

    const hasNext = engine!.nextStep();
    const newState = engine!.getState();
    renderState(newState);

    if (hasNext && isRunning && !isStopping) {
      playNextStep();
    }
  }

  // â”€â”€ Language Selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function startLanguageSelection(): void {
    showVoicePrompt();
    ambientAudio.start(0.05);

    setTimeout(() => {
      announcePrompt(
        'What language would you like to pray the Rosary in? You may say for example: English, Tagalog with Filipino woman, Latin, or Polish.',
        'en-US'
      );
      updateVoiceStatus('Listening for your languageâ€¦', true);
    }, 800);

    recognitionController = startLanguagePrompt(
      (result) => {
        handleLanguageSelected(result.language, result.languageCode, result.voiceDescription);
      },
      (err: string) => {
        console.warn('Recognition error:', err);
        updateVoiceStatus('Could not hear you â€” please type your language or choose below.', false);
      },
      () => {
        updateVoiceStatus('Listeningâ€¦', true);
      }
    );
  }

  function handleLanguageSelected(language: string, languageCode: string, voiceDesc: string): void {
    currentLanguage = language;
    currentLanguageCode = languageCode;
    currentVoiceDesc = voiceDesc || 'elderly rural Piedmontese farmer, gravelly northern Italian drawl, reverent';

    updateVoiceStatus(`âœ Praying in ${language}${voiceDesc ? ` â€” ${voiceDesc}` : ''}`, false);
    recognitionController?.stop();

    savePreferences({
      language: currentLanguage,
      voiceDescription: currentVoiceDesc,
      theme: (document.documentElement.getAttribute('data-theme') as 'night' | 'day') || 'night',
    }).catch(() => {});

    // Update badge
    const badge = el('lang-badge-primary');
    if (badge) { badge.textContent = language; badge.style.display = ''; }

    setTimeout(() => {
      hideVoicePrompt();
      if (!isRunning) startRosary();
    }, 1000);
  }

  // â”€â”€ Start Rosary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function startRosary(): void {
    const mysteryType = getMysteryForDate(new Date());
    engine = new RosaryEngine(mysteryType);
    engine.setLanguage(currentLanguage, currentVoiceDesc);
    engine.subscribe(renderState);

    isRunning = true;
    isStopping = false;
    engine.start();
    renderState(engine.getState());
    playNextStep();
  }

  // â”€â”€ Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  el('play-pause-btn')?.addEventListener('click', () => {
    if (!engine) { startRosary(); return; }
    const state = engine.getState();
    if (state.engineState === 'playing') {
      engine.pause();
      audioManager.pause();
      isRunning = false;
      renderState(engine.getState());
    } else if (state.engineState === 'paused') {
      engine.resume();
      audioManager.resume();
      isRunning = true;
      renderState(engine.getState());
      playNextStep();
    } else {
      isRunning = true;
      engine.start();
      renderState(engine.getState());
      playNextStep();
    }
  });

  el('prev-btn')?.addEventListener('click', () => {
    if (!engine) return;
    isStopping = true;
    audioManager.stop();
    setTimeout(() => {
      isStopping = false;
      engine!.prevStep();
      renderState(engine!.getState());
      if (isRunning) playNextStep();
    }, 100);
  });

  el('next-btn')?.addEventListener('click', () => {
    if (!engine) return;
    isStopping = true;
    audioManager.stop();
    setTimeout(() => {
      isStopping = false;
      engine!.nextStep();
      renderState(engine!.getState());
      if (isRunning) playNextStep();
    }, 100);
  });

  el('theme-toggle')?.addEventListener('click', () => {
    const cur = document.documentElement.getAttribute('data-theme');
    const next = cur === 'day' ? 'night' : 'day';
    applyTheme(next);
    savePreferences({
      language: currentLanguage,
      voiceDescription: currentVoiceDesc,
      theme: next,
    }).catch(() => {});
  });

  el('change-language-btn')?.addEventListener('click', () => {
    isStopping = true;
    audioManager.stop();
    isRunning = false;
    setTimeout(() => {
      isStopping = false;
      startLanguageSelection();
    }, 150);
  });

  el('restart-btn')?.addEventListener('click', () => {
    const msg = el('finished-message');
    if (msg) msg.style.display = 'none';
    isRunning = false;
    isStopping = false;
    audioManager.stop();
    startRosary();
  });

  // Manual language text input
  el('language-text-submit')?.addEventListener('click', () => {
    const input = el<HTMLInputElement>('language-text-input');
    const text = input?.value.trim();
    if (!text) return;
    const parsed = parseVoiceInput(text);
    handleLanguageSelected(parsed.language, parsed.languageCode, parsed.voiceDescription);
  });

  // Download offline
  el('download-offline-btn')?.addEventListener('click', async () => {
    const btn = el('download-offline-btn');
    if (!btn) return;
    btn.textContent = 'Cachingâ€¦';
    btn.setAttribute('disabled', 'true');

    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
      navigator.serviceWorker.controller.postMessage({ type: 'CACHE_ALL' });
    }

    const mysteryType = getMysteryForDate();
    const sequence = buildRosarySequence(mysteryType);
    let cached = 0;

    for (const step of sequence) {
      const text = step.prayer === 'mysteryAnnounce'
        ? `${MYSTERY_SETS[mysteryType].mysteries[step.mysteryIndex ?? 0]?.name ?? ''}`
        : PRAYERS[step.prayer]?.text ?? '';
      if (!text) continue;

      await audioManager.generateAudio({
        text,
        language: currentLanguage,
        languageCode: currentLanguageCode,
        voiceDescription: currentVoiceDesc,
        prayerKey: `${step.prayer}-${step.decadeIndex ?? 0}-${step.hailMaryIndex ?? 0}`,
      });
      cached++;
      btn.textContent = `Caching ${cached}/${sequence.length}â€¦`;
    }

    btn.textContent = 'âœ“ Saved for Lent';
    btn.removeAttribute('disabled');
    setTimeout(() => { btn.textContent = 'ğŸ“¥ Download for Lent'; }, 5000);
  });

  // Voice commands (passive listener)
  (() => {
    const SR = (window as any).SpeechRecognition || (window as any).webkitSpeechRecognition;
    if (!SR) return;
    const r = new SR();
    r.continuous = true; r.lang = 'en-US';
    r.onresult = (ev: any) => {
      const cmd = ev.results[ev.results.length-1][0].transcript.toLowerCase();
      if (cmd.includes('day mode') || cmd.includes('switch to day')) applyTheme('day');
      if (cmd.includes('night mode') || cmd.includes('switch to night')) applyTheme('night');
      if (cmd.includes('pause') && !cmd.includes('un')) { engine?.pause(); isRunning = false; audioManager.pause(); }
      if (cmd.includes('resume') || cmd.includes('continue') || cmd.includes('unpause')) {
        engine?.resume(); isRunning = true; audioManager.resume(); playNextStep();
      }
    };
    try { r.start(); } catch {}
  })();

  // Resume AudioContext on first gesture
  document.addEventListener('click', () => {
    try { (audioManager as any)['audioCtx']?.resume?.(); } catch {}
  }, { once: true });

  // â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function init() {
    const prefs = await loadPreferences();
    applyTheme(prefs?.theme || detectAutoTheme());
    applyMysteryTheme(getMysteryForDate().toString());

    const banner = el('mystery-banner');
    if (banner) banner.textContent = MYSTERY_SETS[getMysteryForDate()]?.name ?? '';

    if (prefs?.language) {
      currentLanguage = prefs.language;
      currentVoiceDesc = prefs.voiceDescription || currentVoiceDesc;

      const resume = el('resume-banner');
      if (resume) {
        resume.style.display = 'flex';
        const langSpan = resume.querySelector('.resume-lang');
        if (langSpan) langSpan.textContent = prefs.language;
      }

      el('resume-yes-btn')?.addEventListener('click', () => {
        el('resume-banner')?.remove();
        hideVoicePrompt();
        ambientAudio.start(0.05);
        startRosary();
      });
      el('resume-no-btn')?.addEventListener('click', () => {
        el('resume-banner')?.remove();
        startLanguageSelection();
      });
    } else {
      startLanguageSelection();
    }
  }

  init().catch(console.error);
</script>

<style>
  .rosary-app {
    position: relative;
    z-index: 1;
    min-height: 100svh;
    display: flex;
    flex-direction: column;
    max-width: 1200px;
    margin: 0 auto;
    padding: env(safe-area-inset-top, 0) env(safe-area-inset-right, 0) env(safe-area-inset-bottom, 0) env(safe-area-inset-left, 0);
  }

  /* Header */
  .app-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1.25rem;
    border-bottom: 1px solid var(--border);
    backdrop-filter: blur(8px);
    background: var(--bg-glass);
    position: sticky;
    top: 0;
    z-index: 10;
    gap: 0.75rem;
  }

  .header-cross {
    font-size: 1.3rem;
    color: var(--gold-dim);
    text-shadow: 0 0 12px var(--gold-glow);
    flex-shrink: 0;
  }

  .header-center {
    flex: 1;
    text-align: center;
  }

  .site-title {
    font-family: 'Cinzel', serif;
    font-size: clamp(1.2rem, 4vw, 1.8rem);
    font-weight: 700;
    letter-spacing: 0.15em;
    color: var(--gold-light);
    text-shadow: 0 0 20px var(--gold-glow);
    line-height: 1;
  }

  .mystery-banner {
    font-family: 'Cormorant Garamond', serif;
    font-style: italic;
    font-size: clamp(0.75rem, 2.5vw, 0.9rem);
    color: var(--text-muted);
    letter-spacing: 0.06em;
    margin-top: 0.15rem;
  }

  .header-controls {
    display: flex;
    gap: 0.4rem;
    flex-shrink: 0;
  }

  .ctrl-btn {
    padding: 0.35rem 0.7rem;
    background: transparent;
    border: 1px solid var(--border-dim);
    color: var(--text-dim);
    border-radius: 20px;
    font-size: 0.8rem;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .ctrl-btn:hover {
    border-color: var(--gold-dim);
    color: var(--gold-light);
    background: rgba(201,168,76,0.07);
  }

  /* Progress */
  .progress-container {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    padding: 0.4rem 1.25rem;
    border-bottom: 1px solid var(--border-dim);
  }

  .progress-bar {
    flex: 1;
    height: 2px;
    background: var(--border-dim);
    border-radius: 1px;
    overflow: hidden;
  }

  .progress-bar-inner {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    border-radius: 1px;
    transition: width 0.5s ease;
    box-shadow: 0 0 6px var(--accent-glow);
  }

  .progress-label {
    font-family: 'Cinzel', serif;
    font-size: 0.65rem;
    color: var(--text-muted);
    letter-spacing: 0.08em;
    white-space: nowrap;
  }

  /* Main content */
  .rosary-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
    flex: 1;
    min-height: 0;
  }

  .bead-panel {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    border-right: 1px solid var(--border-dim);
    min-height: 0;
  }

  .prayer-panel {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    overflow: hidden;
  }

  /* Playback controls */
  .playback-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    padding: 0.75rem 1rem;
    border-top: 1px solid var(--border-dim);
  }

  .ctrl-round {
    width: 40px; height: 40px;
    border-radius: 50%;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-dim);
    font-size: 1rem;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
  }

  .ctrl-round:hover {
    border-color: var(--gold-dim);
    color: var(--gold-light);
    background: rgba(201,168,76,0.07);
  }

  .ctrl-main {
    padding: 0.65rem 2rem;
    background: linear-gradient(135deg, var(--accent), var(--accent));
    color: #fff;
    border-radius: 24px;
    font-family: 'Cinzel', serif;
    font-size: 0.9rem;
    font-weight: 600;
    letter-spacing: 0.08em;
    box-shadow: 0 4px 16px var(--accent-glow);
    transition: all 0.25s;
    border: 1px solid rgba(255,255,255,0.15);
  }

  .ctrl-main:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 24px var(--accent-glow);
    filter: brightness(1.1);
  }

  .ctrl-main:active {
    transform: translateY(0);
  }

  /* Bottom actions */
  .bottom-actions {
    display: flex;
    justify-content: center;
    padding: 0.5rem 1rem 0.75rem;
    border-top: 1px solid var(--border-dim);
  }

  .action-btn {
    padding: 0.4rem 1rem;
    background: transparent;
    border: 1px solid var(--border-dim);
    color: var(--text-muted);
    border-radius: 20px;
    font-size: 0.8rem;
    font-family: 'Cormorant Garamond', serif;
    transition: all 0.2s;
  }

  .action-btn:hover {
    border-color: var(--border);
    color: var(--text-dim);
  }

  .action-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  /* Finished message */
  .finished-message {
    position: fixed;
    inset: 0;
    z-index: 50;
    background: radial-gradient(ellipse at center, #0a0800 0%, #020200 100%);
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    text-align: center;
    padding: 2rem;
    animation: fadeIn 1.5s ease;
  }

  .finished-cross {
    font-size: 3rem;
    color: var(--gold);
    text-shadow: 0 0 30px var(--gold-glow);
    animation: fadeInUp 1s ease;
  }

  .finished-text {
    font-family: 'Cinzel', serif;
    font-size: clamp(1.2rem, 4vw, 1.8rem);
    color: var(--gold-light);
    text-shadow: 0 0 20px var(--gold-glow);
    letter-spacing: 0.1em;
    animation: fadeInUp 1s 0.3s ease both;
  }

  .finished-sub {
    font-family: 'Cormorant Garamond', serif;
    font-style: italic;
    font-size: clamp(0.9rem, 3vw, 1.1rem);
    color: var(--text-dim);
    animation: fadeInUp 1s 0.6s ease both;
  }

  /* Footer */
  .app-footer {
    text-align: center;
    padding: 0.75rem 1rem;
    border-top: 1px solid var(--border-dim);
    font-family: 'Cormorant Garamond', serif;
    font-style: italic;
    color: var(--text-muted);
    font-size: 0.8rem;
    line-height: 1.8;
  }

  .footer-cross { color: var(--gold-dim); margin: 0 0.3rem; }
  .footer-sub { font-size: 0.7rem; color: var(--text-muted); opacity: 0.7; }

  /* â”€â”€ Responsive / Mobile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media (max-width: 640px) {
    .rosary-content {
      grid-template-columns: 1fr;
    }

    .bead-panel {
      border-right: none;
      border-bottom: 1px solid var(--border-dim);
      padding: 0.5rem;
    }
  }

  @media (max-width: 360px) {
    .header-controls .ctrl-btn:last-child {
      display: none;
    }
  }
</style>
