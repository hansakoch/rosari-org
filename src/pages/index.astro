---
import Layout from '../layouts/Layout.astro';
import VoicePrompt from '../components/VoicePrompt.astro';
import RosaryBeads from '../components/RosaryBeads.astro';
import KaraokeText from '../components/KaraokeText.astro';
---

<Layout title="Rosari â€” The Holy Rosary" description="Pray the complete Holy Rosary in any language. A reverent, offline-capable Catholic rosary web app. No ads, no tracking, pure prayer.">

  <VoicePrompt />

  <div class="rosary-app" id="rosary-app">

    <!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <header class="app-header">
      <div class="hdr-left">
        <span class="hdr-cross" aria-hidden="true">âœ</span>
        <span class="hdr-title">Rosari</span>
        <span id="mystery-banner" class="hdr-mystery"></span>
      </div>
      <div class="hdr-right">
        <button id="theme-toggle" class="hdr-btn" aria-label="Toggle day/night">ğŸŒ™</button>
        <button id="change-language-btn" class="hdr-btn" aria-label="Change language" title="Change language">ğŸŒ</button>
      </div>
    </header>

    <!-- â”€â”€ Thin progress bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="progress-bar-wrap" role="progressbar" aria-label="Rosary progress">
      <div id="progress-bar-inner" class="progress-bar-fill"></div>
    </div>

    <!-- â”€â”€ Rosary visualization (fills all free space) â”€â”€â”€â”€â”€ -->
    <div class="bead-stage" aria-label="Rosary beads">
      <RosaryBeads />
    </div>

    <!-- â”€â”€ Karaoke text window â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="text-stage">
      <KaraokeText />
    </div>

    <!-- â”€â”€ Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="controls-bar" role="group" aria-label="Playback controls">
      <button id="prev-btn" class="ctrl-skip" aria-label="Previous prayer">â®</button>
      <button id="play-pause-btn" class="ctrl-main" aria-label="Begin rosary">â–¶ Begin</button>
      <button id="next-btn" class="ctrl-skip" aria-label="Skip prayer">â­</button>
      <button id="download-offline-btn" class="ctrl-dl" aria-label="Download for offline use">ğŸ“¥</button>
    </div>

    <!-- â”€â”€ Footer (dynamic liturgical season) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <footer class="app-footer" id="app-footer">
      <span class="ftr-cross" aria-hidden="true">âœ</span>
      <span id="season-tagline" class="ftr-tagline"></span>
      <span class="ftr-cross" aria-hidden="true">âœ</span>
      <span class="ftr-brand">rosari.org</span>
    </footer>

    <!-- â”€â”€ Finished overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="finished-message" class="finished-overlay" style="display:none;" role="status">
      <div class="fin-cross" aria-hidden="true">âœ</div>
      <p class="fin-text">Praised be Jesus Christ.</p>
      <p class="fin-sub">The Rosary is complete. Go in peace.</p>
      <button id="restart-btn" class="ctrl-main" style="margin-top:1.2rem;">Pray Again</button>
    </div>

  </div>
</Layout>

<script>
  import {
    getMysteryForDate, MYSTERY_SETS, PRAYERS, PRAYERS_LATIN,
    buildRosarySequence, getLiturgicalSeason, getPrayerForLanguage
  } from '../scripts/rosary-data.ts';
  import { RosaryEngine } from '../scripts/rosary-engine.ts';
  import { audioManager, ambientAudio } from '../scripts/audio-manager.ts';
  import { savePreferences, loadPreferences } from '../scripts/storage-manager.ts';
  import { startLanguagePrompt, announcePrompt, parseVoiceInput } from '../scripts/voice-recognition.ts';

  // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let engine: RosaryEngine | null = null;
  let currentLanguageCode = 'en-US';
  let currentLanguage = 'English';
  let currentVoiceDesc = 'elderly rural Piedmontese farmer, gravelly northern Italian drawl, slow, reverent';
  let isRunning = false;
  let isStopping = false;
  let recognitionController: { stop: () => void } | null = null;

  const el = <T extends HTMLElement = HTMLElement>(id: string) =>
    document.getElementById(id) as T | null;

  // â”€â”€ Liturgical season (set once on boot) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function initSeasonalFooter(): void {
    const info = getLiturgicalSeason();
    const tagline = el('season-tagline');
    if (tagline) tagline.textContent = info.tagline;
    const dlBtn = el('download-offline-btn');
    if (dlBtn) dlBtn.title = info.downloadLabel;
  }

  // â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function applyTheme(theme: 'night' | 'day'): void {
    document.documentElement.setAttribute('data-theme', theme);
    const btn = el('theme-toggle');
    if (btn) btn.textContent = theme === 'night' ? 'â˜€ï¸' : 'ğŸŒ™';
  }

  function detectAutoTheme(): 'night' | 'day' {
    const h = new Date().getHours();
    return (h >= 20 || h < 7) ? 'night' : 'day';
  }

  function applyMysteryTheme(type: string): void {
    document.documentElement.setAttribute('data-mystery', type);
    const set = MYSTERY_SETS[type as keyof typeof MYSTERY_SETS];
    if (set) {
      document.documentElement.style.setProperty('--accent', set.color.primary);
      document.documentElement.style.setProperty('--accent2', set.color.secondary);
      document.documentElement.style.setProperty('--accent-glow', `${set.color.primary}44`);
    }
  }

  // â”€â”€ Voice Prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showVoicePrompt(): void {
    const o = el('voice-prompt-overlay');
    if (o) { o.style.display = 'flex'; o.style.opacity = '1'; }
  }

  function hideVoicePrompt(): void {
    const o = el('voice-prompt-overlay');
    if (o) {
      o.style.transition = 'opacity 0.6s ease';
      o.style.opacity = '0';
      setTimeout(() => { if (o) o.style.display = 'none'; }, 600);
    }
  }

  function updateVoiceStatus(text: string, listening = false): void {
    const s = el('voice-status');
    if (!s) return;
    s.textContent = text;
    s.classList.toggle('listening', listening);
    el('mic-ring')?.classList.toggle('listening', listening);
  }

  // â”€â”€ Karaoke: windowed display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateKaraoke(text: string, wordIdx: number, title: string): void {
    const container = el('karaoke-primary');
    if (!container) return;

    const words = text.split(/\s+/).filter(Boolean);
    const BEFORE = 3;   // words shown before current
    const NEAR   = 2;   // words at medium opacity after current
    const FAR    = 2;   // words at low opacity after those

    const start = Math.max(0, wordIdx - BEFORE);
    const end   = Math.min(words.length, wordIdx + NEAR + FAR + 1);

    const parts: string[] = [];

    if (start > 0) parts.push(`<span class="kw kw-ellipsis">â€¦</span>`);

    for (let i = start; i < end; i++) {
      const w = words[i]!;
      const dist = i - wordIdx;
      let cls = 'kw';
      if (dist < 0)          cls += ' kw-past';
      else if (dist === 0)   cls += ' kw-active';
      else if (dist <= NEAR) cls += ' kw-next';
      else                   cls += ' kw-far';
      parts.push(`<span class="${cls}">${w}</span>`);
    }

    if (end < words.length) parts.push(`<span class="kw kw-ellipsis">â€¦</span>`);

    container.innerHTML = parts.join(' ');

    const titleEl = el('prayer-title');
    if (titleEl) titleEl.textContent = title;
  }

  // â”€â”€ Bead update â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateBeads(activeBeadIndex: number): void {
    (window as any).updateBeads?.(activeBeadIndex);
  }

  // â”€â”€ Mystery display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateMysteryDisplay(name: string, meditation: string, isMystery: boolean): void {
    el('mystery-announcement')?.style.setProperty('display', isMystery ? 'block' : 'none');
    const nameEl = el('mystery-name');
    const medEl  = el('mystery-meditation');
    if (nameEl) nameEl.textContent = name;
    if (medEl)  medEl.textContent  = meditation;
  }

  // â”€â”€ Progress bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateProgress(step: number, total: number): void {
    const bar = el('progress-bar-inner');
    if (bar) bar.style.width = `${total > 0 ? (step / total) * 100 : 0}%`;
  }

  // â”€â”€ Localized prayer text lookup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function getPrayerText(prayerKey: string): { text: string; title: string } {
    const prayer = getPrayerForLanguage(prayerKey, currentLanguage);
    return { text: prayer.text, title: prayer.title };
  }

  // â”€â”€ Main render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderState(state: ReturnType<RosaryEngine['getState']>): void {
    applyMysteryTheme(state.mysteryType);
    updateBeads(state.currentBeadIndex);

    const isMystery = state.currentStep.prayer === 'mysteryAnnounce';

    // Use localized prayer text for display
    const localPrayer = isMystery
      ? { text: state.currentMeditationText, title: state.currentPrayerTitle }
      : getPrayerText(state.currentStep.prayer);

    updateKaraoke(
      localPrayer.text || state.currentPrayerText,
      state.wordIndex,
      localPrayer.title || state.currentPrayerTitle
    );

    updateMysteryDisplay(state.currentMysteryName, state.currentMeditationText, isMystery);
    updateProgress(state.currentStepIndex, state.totalSteps);

    const banner = el('mystery-banner');
    if (banner) banner.textContent = MYSTERY_SETS[state.mysteryType]?.name ?? '';

    const playBtn = el('play-pause-btn');
    if (playBtn) {
      playBtn.textContent = state.engineState === 'playing' ? 'â¸ Pause'
        : state.engineState === 'paused' ? 'â–¶ Resume'
        : 'â–¶ Begin';
    }

    if (state.engineState === 'finished') {
      isRunning = false;
      const msg = el('finished-message');
      if (msg) msg.style.display = 'flex';
    }
  }

  // â”€â”€ Playback loop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function playNextStep(): Promise<void> {
    if (!engine || !isRunning || isStopping) return;
    const state = engine.getState();
    if (state.engineState !== 'playing') return;

    const step = state.currentStep;
    const isMystery = step.prayer === 'mysteryAnnounce';

    // Use localized prayer text for TTS
    let ttsText: string;
    if (isMystery) {
      ttsText = `${state.currentPrayerTitle}. ${state.currentMeditationText}`;
    } else {
      const localized = getPrayerText(step.prayer);
      ttsText = localized.text || state.currentPrayerText;
    }

    const prayerKey = `${step.prayer}-d${step.decadeIndex ?? 0}-h${step.hailMaryIndex ?? 0}`;

    await audioManager.playStep(
      ttsText,
      {
        text: ttsText,
        language: currentLanguage,
        languageCode: currentLanguageCode,
        voiceDescription: currentVoiceDesc,
        prayerKey,
      },
      (wordIdx: number) => {
        engine?.setWordIndex(wordIdx);
        renderState(engine!.getState());
      },
      () => {}
    );

    if (!isRunning || isStopping) return;

    const pause = step.prayer === 'mysteryAnnounce' ? 2200
      : step.prayer === 'fatimaPrayer' ? 900
      : step.prayer === 'gloryBe' ? 700
      : 450;

    await new Promise(r => setTimeout(r, pause));
    if (!isRunning || isStopping) return;

    const hasNext = engine!.nextStep();
    const newState = engine!.getState();
    renderState(newState);

    if (hasNext && isRunning && !isStopping) playNextStep();
  }

  // â”€â”€ Language selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function startLanguageSelection(): void {
    showVoicePrompt();
    ambientAudio.start(0.05);

    setTimeout(() => {
      announcePrompt('What language would you like to pray the Rosary in?', 'en-US');
      updateVoiceStatus('Listening for your languageâ€¦', true);
    }, 800);

    recognitionController = startLanguagePrompt(
      (result) => handleLanguageSelected(result.language, result.languageCode, result.voiceDescription),
      (err) => {
        console.warn('Recognition error:', err);
        updateVoiceStatus('Type your language below and press Begin.', false);
      },
      () => updateVoiceStatus('Listeningâ€¦', true)
    );
  }

  function handleLanguageSelected(language: string, languageCode: string, voiceDesc: string): void {
    currentLanguage    = language;
    currentLanguageCode = languageCode;
    currentVoiceDesc   = voiceDesc || 'elderly rural Piedmontese farmer, gravelly northern Italian drawl, reverent';

    updateVoiceStatus(`âœ Praying in ${language}`, false);
    recognitionController?.stop();

    savePreferences({
      language: currentLanguage,
      voiceDescription: currentVoiceDesc,
      theme: (document.documentElement.getAttribute('data-theme') as 'night' | 'day') || 'night',
    }).catch(() => {});

    setTimeout(() => {
      hideVoicePrompt();
      if (!isRunning) startRosary();
    }, 800);
  }

  // â”€â”€ Start rosary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function startRosary(): void {
    const mysteryType = getMysteryForDate(new Date());
    engine = new RosaryEngine(mysteryType);
    engine.setLanguage(currentLanguage, currentVoiceDesc);
    engine.subscribe(renderState);
    isRunning = true;
    isStopping = false;
    engine.start();
    renderState(engine.getState());
    playNextStep();
  }

  // â”€â”€ Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  el('play-pause-btn')?.addEventListener('click', () => {
    if (!engine) { startRosary(); return; }
    const state = engine.getState();
    if (state.engineState === 'playing') {
      engine.pause(); audioManager.pause(); isRunning = false;
      renderState(engine.getState());
    } else if (state.engineState === 'paused') {
      engine.resume(); audioManager.resume(); isRunning = true;
      renderState(engine.getState()); playNextStep();
    } else {
      isRunning = true; engine.start(); renderState(engine.getState()); playNextStep();
    }
  });

  el('prev-btn')?.addEventListener('click', () => {
    if (!engine) return;
    isStopping = true; audioManager.stop();
    setTimeout(() => {
      isStopping = false; engine!.prevStep();
      renderState(engine!.getState());
      if (isRunning) playNextStep();
    }, 100);
  });

  el('next-btn')?.addEventListener('click', () => {
    if (!engine) return;
    isStopping = true; audioManager.stop();
    setTimeout(() => {
      isStopping = false; engine!.nextStep();
      renderState(engine!.getState());
      if (isRunning) playNextStep();
    }, 100);
  });

  el('theme-toggle')?.addEventListener('click', () => {
    const cur = document.documentElement.getAttribute('data-theme');
    const next = cur === 'day' ? 'night' : 'day';
    applyTheme(next);
    savePreferences({ language: currentLanguage, voiceDescription: currentVoiceDesc, theme: next }).catch(() => {});
  });

  el('change-language-btn')?.addEventListener('click', () => {
    isStopping = true; audioManager.stop(); isRunning = false;
    setTimeout(() => { isStopping = false; startLanguageSelection(); }, 150);
  });

  el('restart-btn')?.addEventListener('click', () => {
    el('finished-message')!.style.display = 'none';
    isRunning = false; isStopping = false; audioManager.stop();
    startRosary();
  });

  el('language-text-submit')?.addEventListener('click', () => {
    const input = el<HTMLInputElement>('language-text-input');
    const text = input?.value.trim();
    if (!text) return;
    const parsed = parseVoiceInput(text);
    handleLanguageSelected(parsed.language, parsed.languageCode, parsed.voiceDescription);
  });

  el('download-offline-btn')?.addEventListener('click', async () => {
    const btn = el('download-offline-btn');
    if (!btn) return;
    const info = getLiturgicalSeason();
    btn.title = 'Cachingâ€¦';
    btn.setAttribute('disabled', 'true');

    const mysteryType = getMysteryForDate();
    const sequence = buildRosarySequence(mysteryType);
    let cached = 0;

    for (const step of sequence) {
      let text = '';
      if (step.prayer === 'mysteryAnnounce') {
        text = MYSTERY_SETS[mysteryType].mysteries[step.mysteryIndex ?? 0]?.name ?? '';
      } else {
        text = getPrayerForLanguage(step.prayer, currentLanguage).text;
      }
      if (!text) continue;

      await audioManager.generateAudio({
        text,
        language: currentLanguage,
        languageCode: currentLanguageCode,
        voiceDescription: currentVoiceDesc,
        prayerKey: `${step.prayer}-${step.decadeIndex ?? 0}-${step.hailMaryIndex ?? 0}`,
      });
      cached++;
    }

    btn.title = info.downloadLabel;
    btn.removeAttribute('disabled');
  });

  // Voice commands (passive)
  (() => {
    const SR = (window as any).SpeechRecognition || (window as any).webkitSpeechRecognition;
    if (!SR) return;
    const r = new SR();
    r.continuous = true; r.lang = 'en-US';
    r.onresult = (ev: any) => {
      const cmd = ev.results[ev.results.length-1][0].transcript.toLowerCase();
      if (cmd.includes('day mode')) applyTheme('day');
      if (cmd.includes('night mode')) applyTheme('night');
      if (cmd.includes('pause') && !cmd.includes('un')) { engine?.pause(); isRunning = false; audioManager.pause(); }
      if (cmd.includes('resume') || cmd.includes('continue')) { engine?.resume(); isRunning = true; audioManager.resume(); playNextStep(); }
    };
    try { r.start(); } catch {}
  })();

  document.addEventListener('click', () => {
    try { (audioManager as any)['audioCtx']?.resume?.(); } catch {}
  }, { once: true });

  // â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function init() {
    initSeasonalFooter();
    const prefs = await loadPreferences();
    applyTheme(prefs?.theme || detectAutoTheme());
    applyMysteryTheme(getMysteryForDate().toString());

    const banner = el('mystery-banner');
    if (banner) banner.textContent = MYSTERY_SETS[getMysteryForDate()]?.name ?? '';

    if (prefs?.language) {
      currentLanguage    = prefs.language;
      currentVoiceDesc   = prefs.voiceDescription || currentVoiceDesc;

      const resume = el('resume-banner');
      if (resume) {
        resume.style.display = 'flex';
        const langSpan = resume.querySelector('.resume-lang');
        if (langSpan) langSpan.textContent = prefs.language;
      }

      el('resume-yes-btn')?.addEventListener('click', () => {
        el('resume-banner')?.remove();
        hideVoicePrompt();
        ambientAudio.start(0.05);
        startRosary();
      });
      el('resume-no-btn')?.addEventListener('click', () => {
        el('resume-banner')?.remove();
        startLanguageSelection();
      });
    } else {
      startLanguageSelection();
    }
  }

  init().catch(console.error);
</script>

<style>
  /* â”€â”€ Full-screen app shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .rosary-app {
    position: fixed;
    inset: 0;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: var(--bg);
    /* Safe area for notch/home bar */
    padding-top: env(safe-area-inset-top, 0);
    padding-bottom: env(safe-area-inset-bottom, 0);
  }

  /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .app-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.4rem 0.8rem;
    border-bottom: 1px solid var(--border-dim);
    background: var(--bg-glass);
    backdrop-filter: blur(8px);
    flex-shrink: 0;
    gap: 0.5rem;
    z-index: 5;
    min-height: 42px;
  }

  .hdr-left {
    display: flex;
    align-items: center;
    gap: 0.55rem;
    overflow: hidden;
    min-width: 0;
  }

  .hdr-cross {
    font-size: 1.05rem;
    color: var(--gold-dim);
    text-shadow: 0 0 10px var(--gold-glow);
    flex-shrink: 0;
  }

  .hdr-title {
    font-family: 'Cinzel', serif;
    font-size: clamp(1rem, 3vw, 1.4rem);
    font-weight: 700;
    letter-spacing: 0.14em;
    color: var(--gold-light);
    text-shadow: 0 0 16px var(--gold-glow);
    flex-shrink: 0;
  }

  .hdr-mystery {
    font-family: 'Cormorant Garamond', serif;
    font-style: italic;
    font-size: clamp(0.68rem, 2vw, 0.85rem);
    color: var(--text-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .hdr-right {
    display: flex;
    gap: 0.3rem;
    flex-shrink: 0;
  }

  .hdr-btn {
    width: 36px; height: 36px;
    border-radius: 50%;
    background: transparent;
    border: 1px solid var(--border-dim);
    color: var(--text-dim);
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .hdr-btn:hover {
    border-color: var(--gold-dim);
    background: rgba(201,168,76,0.08);
  }

  /* â”€â”€ Progress bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .progress-bar-wrap {
    height: 2px;
    background: var(--border-dim);
    flex-shrink: 0;
    overflow: hidden;
  }

  .progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    width: 0%;
    transition: width 0.5s ease;
    box-shadow: 0 0 6px var(--accent-glow);
  }

  /* â”€â”€ Bead stage: takes all remaining vertical space â”€â”€â”€â”€â”€â”€â”€â”€ */
  .bead-stage {
    flex: 1;
    min-height: 0;
    overflow: hidden;
    display: flex;
    align-items: stretch;
    justify-content: center;
  }

  /* â”€â”€ Text stage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .text-stage {
    flex-shrink: 0;
    border-top: 1px solid var(--border-dim);
    background: rgba(10, 9, 6, 0.6);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 0;
  }

  /* â”€â”€ Controls bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .controls-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 0.6rem 1rem;
    border-top: 1px solid var(--border-dim);
    background: var(--bg-glass);
    flex-shrink: 0;
  }

  .ctrl-skip {
    width: 44px; height: 44px;
    border-radius: 50%;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-dim);
    font-size: 1.1rem;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
  }
  .ctrl-skip:hover { border-color: var(--gold-dim); color: var(--gold-light); background: rgba(201,168,76,0.07); }

  .ctrl-main {
    padding: 0.6rem 2.2rem;
    background: linear-gradient(135deg, var(--accent), var(--accent));
    color: #fff;
    border-radius: 28px;
    font-family: 'Cinzel', serif;
    font-size: clamp(0.8rem, 2.5vw, 1rem);
    font-weight: 600;
    letter-spacing: 0.08em;
    box-shadow: 0 4px 18px var(--accent-glow);
    transition: all 0.25s;
    border: 1px solid rgba(255,255,255,0.15);
    min-width: 120px;
  }
  .ctrl-main:hover { transform: translateY(-1px); box-shadow: 0 6px 24px var(--accent-glow); filter: brightness(1.1); }
  .ctrl-main:active { transform: translateY(0); }

  .ctrl-dl {
    width: 44px; height: 44px;
    border-radius: 50%;
    background: transparent;
    border: 1px solid var(--border-dim);
    color: var(--text-muted);
    font-size: 1.1rem;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
  }
  .ctrl-dl:hover { border-color: var(--border); color: var(--text-dim); }
  .ctrl-dl:disabled { opacity: 0.5; cursor: not-allowed; }

  /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .app-footer {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.3rem 1rem;
    border-top: 1px solid var(--border-dim);
    font-family: 'Cormorant Garamond', serif;
    font-style: italic;
    font-size: clamp(0.68rem, 2vw, 0.82rem);
    color: var(--text-muted);
    flex-shrink: 0;
    background: var(--bg);
    opacity: 0.75;
  }

  .ftr-cross { color: var(--gold-dim); }
  .ftr-tagline { letter-spacing: 0.04em; }
  .ftr-brand { font-size: 0.75em; opacity: 0.6; letter-spacing: 0.06em; }

  /* â”€â”€ Finished overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .finished-overlay {
    position: fixed;
    inset: 0;
    z-index: 50;
    background: radial-gradient(ellipse at center, #0a0800 0%, #020200 100%);
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    text-align: center;
    padding: 2rem;
    animation: fadeIn 1.5s ease;
  }

  .fin-cross { font-size: clamp(2rem, 8vw, 3.5rem); color: var(--gold); text-shadow: 0 0 30px var(--gold-glow); animation: fadeInUp 1s ease; }
  .fin-text  { font-family: 'Cinzel', serif; font-size: clamp(1.1rem, 4vw, 1.8rem); color: var(--gold-light); text-shadow: 0 0 20px var(--gold-glow); letter-spacing: 0.1em; animation: fadeInUp 1s 0.3s ease both; }
  .fin-sub   { font-family: 'Cormorant Garamond', serif; font-style: italic; font-size: clamp(0.9rem, 3vw, 1.1rem); color: var(--text-dim); animation: fadeInUp 1s 0.6s ease both; }
</style>
