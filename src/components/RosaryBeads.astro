---
// RosaryBeads.astro â€” SVG rosary bead visualization
// Positions are pre-calculated for a clean oval layout
---

<div class="rosary-container" role="img" aria-label="Rosary bead visualization">
  <svg
    id="rosary-svg"
    viewBox="0 0 480 400"
    xmlns="http://www.w3.org/2000/svg"
    aria-hidden="true"
    class="rosary-svg"
  >
    <!-- Gradient definitions -->
    <defs>
      <radialGradient id="beadGrad-hm" cx="35%" cy="30%">
        <stop offset="0%" stop-color="#8a6a2a" />
        <stop offset="100%" stop-color="#2a1a00" />
      </radialGradient>
      <radialGradient id="beadGrad-of" cx="35%" cy="30%">
        <stop offset="0%" stop-color="#c09030" />
        <stop offset="100%" stop-color="#3a2000" />
      </radialGradient>
      <radialGradient id="beadGrad-active" cx="35%" cy="30%">
        <stop offset="0%" stop-color="#ffffff" stop-opacity="0.9" />
        <stop offset="40%" stop-color="var(--accent2)" />
        <stop offset="100%" stop-color="var(--accent)" />
      </radialGradient>
      <filter id="bead-glow" x="-50%" y="-50%" width="200%" height="200%">
        <feGaussianBlur stdDeviation="3" result="blur"/>
        <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
      </filter>
      <filter id="bead-glow-strong" x="-80%" y="-80%" width="260%" height="260%">
        <feGaussianBlur stdDeviation="5" result="blur"/>
        <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
      </filter>
    </defs>

    <!-- Rosary chain (oval path) -->
    <ellipse
      cx="240" cy="190"
      rx="150" ry="125"
      fill="none"
      stroke="var(--gold-dim)"
      stroke-width="1.2"
      stroke-dasharray="4,3"
      opacity="0.4"
    />

    <!-- Tail chain line -->
    <line x1="240" y1="315" x2="240" y2="390"
      stroke="var(--gold-dim)" stroke-width="1.2" opacity="0.4" />

    <!-- Crucifix (bead 0) -->
    <g id="bead-0" class="rosary-bead bead-crucifix" data-bead-idx="0" transform="translate(240, 400)">
      <!-- Cross shape -->
      <rect x="-5" y="-20" width="10" height="36" rx="1" fill="var(--gold-dim)" opacity="0.8"/>
      <rect x="-12" y="-8" width="24" height="8" rx="1" fill="var(--gold-dim)" opacity="0.8"/>
      <ellipse cx="0" cy="4" rx="3" ry="4" fill="var(--gold-dim)" opacity="0.7"/>
      <!-- Circle on top -->
      <circle cx="0" cy="-22" r="5" fill="url(#beadGrad-hm)" stroke="var(--gold-dim)" stroke-width="0.8"/>
    </g>

    <!-- Tail beads: bead 1 (OF) and beads 2-4 (HM) and bead 5 (connector) -->
    <!-- These are positioned along the tail below the oval bottom -->
    <!-- idx 1: OF at y=378 -->
    <circle id="bead-1" class="rosary-bead bead-of" data-bead-idx="1"
      cx="240" cy="378" r="8"
      fill="url(#beadGrad-of)" stroke="var(--gold-dim)" stroke-width="0.8" />

    <!-- idx 2-4: HM beads -->
    <circle id="bead-2" class="rosary-bead bead-hm" data-bead-idx="2"
      cx="240" cy="358" r="6"
      fill="url(#beadGrad-hm)" stroke="#4a3010" stroke-width="0.7" />
    <circle id="bead-3" class="rosary-bead bead-hm" data-bead-idx="3"
      cx="240" cy="342" r="6"
      fill="url(#beadGrad-hm)" stroke="#4a3010" stroke-width="0.7" />
    <circle id="bead-4" class="rosary-bead bead-hm" data-bead-idx="4"
      cx="240" cy="326" r="6"
      fill="url(#beadGrad-hm)" stroke="#4a3010" stroke-width="0.7" />

    <!-- idx 5: Connector bead at loop bottom -->
    <circle id="bead-5" class="rosary-bead bead-connector" data-bead-idx="5"
      cx="240" cy="315" r="7"
      fill="url(#beadGrad-of)" stroke="var(--gold-dim)" stroke-width="0.8" />

    <!-- Decade beads: dynamically generated via JS -->
    <!-- Decade 1: beads 6-16 (OF + 10 HM) -->
    <!-- Decade 2: beads 17-27 -->
    <!-- ... up to Decade 5: beads 51-61 -->
    <!-- JS will populate these -->
    <g id="loop-beads"></g>

  </svg>

  <!-- Decade progress dots (mobile-friendly indicator) -->
  <div class="decade-dots" aria-label="Decade progress">
    {[0,1,2,3,4].map(d => (
      <div class="decade-dot" data-decade={d} aria-label={`Decade ${d+1}`}></div>
    ))}
  </div>
</div>

<script>
  import { getBeadPositions } from '../scripts/rosary-data.ts';

  function initBeads() {
    const svg = document.getElementById('rosary-svg');
    const loopGroup = document.getElementById('loop-beads');
    if (!svg || !loopGroup) return;

    const positions = getBeadPositions(240, 190, 150, 125);
    // Positions 0-5 are already rendered as static SVG (crucifix + tail)
    // Positions 6+ are loop beads

    loopGroup.innerHTML = '';

    for (let i = 6; i < positions.length; i++) {
      const pos = positions[i]!;
      const isOf = pos.type === 'of';
      const r = isOf ? 8 : 5.5;

      const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      circle.id = `bead-${i}`;
      circle.setAttribute('class', `rosary-bead bead-${pos.type}`);
      circle.setAttribute('data-bead-idx', String(i));
      circle.setAttribute('cx', String(Math.round(pos.x * 10) / 10));
      circle.setAttribute('cy', String(Math.round(pos.y * 10) / 10));
      circle.setAttribute('r', String(r));
      circle.setAttribute('fill', isOf ? 'url(#beadGrad-of)' : 'url(#beadGrad-hm)');
      circle.setAttribute('stroke', isOf ? 'var(--gold-dim)' : '#3a2a08');
      circle.setAttribute('stroke-width', isOf ? '0.9' : '0.6');

      loopGroup.appendChild(circle);
    }
  }

  // Update decade dots based on active bead
  function updateDecadeDots(beadIndex: number) {
    if (beadIndex < 6) return;
    const decadeIdx = Math.floor((beadIndex - 6) / 11);
    document.querySelectorAll('.decade-dot').forEach((dot, i) => {
      dot.classList.toggle('active', i === decadeIdx);
      dot.classList.toggle('done', i < decadeIdx);
    });
  }

  // Expose update function globally for app.ts
  (window as any).updateDecadeDots = updateDecadeDots;

  initBeads();
</script>

<style>
  .rosary-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem;
  }

  .rosary-svg {
    width: 100%;
    max-width: 420px;
    height: auto;
    max-height: 50svh;
    filter: drop-shadow(0 0 30px rgba(0,0,0,0.8));
  }

  /* Bead states */
  .rosary-bead {
    transition: filter 0.3s ease, transform 0.3s ease, opacity 0.3s;
    transform-origin: center;
    transform-box: fill-box;
    cursor: pointer;
  }

  .rosary-bead.prayed {
    opacity: 0.55;
  }

  .rosary-bead.active {
    animation: beadPulse 1.8s ease-in-out infinite;
    filter: drop-shadow(0 0 6px var(--accent)) drop-shadow(0 0 12px var(--accent));
  }

  .rosary-bead.active circle,
  circle.rosary-bead.active {
    fill: url(#beadGrad-active) !important;
  }

  .bead-crucifix.active {
    filter: drop-shadow(0 0 8px gold) drop-shadow(0 0 20px var(--gold-glow));
    animation: beadPulse 2s ease-in-out infinite;
  }

  /* Decade dots */
  .decade-dots {
    display: flex;
    gap: 0.6rem;
    padding: 0.4rem;
  }

  .decade-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    border: 1.5px solid var(--gold-dim);
    background: transparent;
    transition: all 0.4s ease;
  }

  .decade-dot.active {
    background: var(--accent);
    border-color: var(--accent2);
    box-shadow: 0 0 8px var(--accent-glow);
  }

  .decade-dot.done {
    background: var(--gold-dim);
    border-color: transparent;
    opacity: 0.5;
  }

  /* Mobile adjustments */
  @media (max-width: 480px) {
    .rosary-svg {
      max-height: 42svh;
    }
  }
</style>
