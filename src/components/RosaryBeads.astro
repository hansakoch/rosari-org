---
// RosaryBeads.astro — Full-screen animated rosary bead visualization
---

<div class="rosary-wrap" id="rosary-wrap" role="img" aria-label="Rosary bead visualization">
  <svg
    id="rosary-svg"
    viewBox="0 0 600 540"
    xmlns="http://www.w3.org/2000/svg"
    aria-hidden="true"
    preserveAspectRatio="xMidYMid meet"
  >
    <defs>
      <!-- Bead gradients -->
      <radialGradient id="bg-hm" cx="32%" cy="28%" r="68%">
        <stop offset="0%" stop-color="#b8954a"/>
        <stop offset="55%" stop-color="#6a4518"/>
        <stop offset="100%" stop-color="#1e0e00"/>
      </radialGradient>
      <radialGradient id="bg-of" cx="32%" cy="28%" r="68%">
        <stop offset="0%" stop-color="#e8c060"/>
        <stop offset="55%" stop-color="#9a6820"/>
        <stop offset="100%" stop-color="#2e1400"/>
      </radialGradient>
      <radialGradient id="bg-active" cx="28%" cy="24%" r="72%">
        <stop offset="0%" stop-color="rgba(255,255,255,0.95)"/>
        <stop offset="30%" stop-color="var(--accent2)"/>
        <stop offset="100%" stop-color="var(--accent)"/>
      </radialGradient>
      <radialGradient id="bg-prayed" cx="32%" cy="28%" r="68%">
        <stop offset="0%" stop-color="#5a4020"/>
        <stop offset="100%" stop-color="#0e0600"/>
      </radialGradient>

      <!-- Chain line style -->
      <marker id="chain-end" markerWidth="4" markerHeight="4" refX="2" refY="2">
        <circle cx="2" cy="2" r="1.5" fill="var(--gold-dim)" opacity="0.5"/>
      </marker>

      <!-- Glow filter - normal -->
      <filter id="glow" x="-60%" y="-60%" width="220%" height="220%">
        <feGaussianBlur stdDeviation="4" result="blur"/>
        <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
      </filter>

      <!-- Strong glow for active bead -->
      <filter id="glow-strong" x="-100%" y="-100%" width="300%" height="300%">
        <feGaussianBlur stdDeviation="7" result="blur1"/>
        <feGaussianBlur stdDeviation="14" result="blur2"/>
        <feMerge>
          <feMergeNode in="blur2"/>
          <feMergeNode in="blur1"/>
          <feMergeNode in="SourceGraphic"/>
        </feMerge>
      </filter>
    </defs>

    <!-- Main oval chain -->
    <ellipse
      cx="300" cy="230"
      rx="228" ry="183"
      fill="none"
      stroke="var(--gold-dim)"
      stroke-width="1.5"
      stroke-dasharray="5,4"
      opacity="0.35"
    />

    <!-- Tail chain -->
    <line x1="300" y1="413" x2="300" y2="525"
      stroke="var(--gold-dim)" stroke-width="1.5" opacity="0.35"/>

    <!-- Crucifix (always rendered at tail bottom) -->
    <g id="bead-crucifix" class="bead-group bead-crucifix" data-bead-idx="0"
       transform="translate(300,530)">
      <!-- Cross -->
      <rect x="-5.5" y="-22" width="11" height="42" rx="2" fill="var(--gold-dim)" opacity="0.85"/>
      <rect x="-14" y="-8" width="28" height="9" rx="2" fill="var(--gold-dim)" opacity="0.85"/>
      <!-- INRI -->
      <text x="0" y="-11" text-anchor="middle" font-family="serif" font-size="5"
        fill="#0a0600" opacity="0.7" letter-spacing="0.5">INRI</text>
      <!-- Corpus (simplified) -->
      <ellipse cx="0" cy="3" rx="4" ry="6" fill="var(--gold)" opacity="0.6"/>
      <!-- Top connector bead -->
      <circle cx="0" cy="-24" r="7" fill="url(#bg-hm)" stroke="var(--gold-dim)" stroke-width="1"/>
    </g>

    <!-- Bead groups (filled by JS) -->
    <g id="tail-beads"></g>
    <g id="loop-beads"></g>
  </svg>

  <!-- Decade indicator: 5 glowing dots at bottom -->
  <div class="decade-track" aria-label="Decade progress">
    {[1,2,3,4,5].map(d => (
      <div class="dec-dot" data-decade={d-1} aria-label={`Decade ${d}`}>
        <span class="dec-num">{d}</span>
      </div>
    ))}
  </div>
</div>

<script>
  import { getBeadPositions } from '../scripts/rosary-data.ts';

  const CX = 300, CY = 230, RX = 228, RY = 183;
  const positions = getBeadPositions(CX, CY, RX, RY);

  function makeBead(
    idx: number,
    x: number, y: number,
    r: number,
    type: string,
    container: SVGGElement
  ): void {
    const isCrucifix = type === 'crucifix';
    if (isCrucifix) return; // rendered statically

    const isOf = type === 'of' || type === 'connector';

    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    g.setAttribute('class', `bead-group bead-${type}`);
    g.setAttribute('data-bead-idx', String(idx));
    g.setAttribute('data-bead-x', String(x));
    g.setAttribute('data-bead-y', String(y));

    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    circle.setAttribute('cx', String(x));
    circle.setAttribute('cy', String(y));
    circle.setAttribute('r', String(r));
    circle.setAttribute('fill', isOf ? 'url(#bg-of)' : 'url(#bg-hm)');
    circle.setAttribute('stroke', isOf ? 'var(--gold-dim)' : '#3a2508');
    circle.setAttribute('stroke-width', isOf ? '1.2' : '0.8');
    circle.setAttribute('class', 'rosary-bead');

    // Specular highlight
    const shine = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
    const sr = r * 0.38;
    shine.setAttribute('cx', String(x - r * 0.22));
    shine.setAttribute('cy', String(y - r * 0.26));
    shine.setAttribute('rx', String(sr));
    shine.setAttribute('ry', String(sr * 0.6));
    shine.setAttribute('fill', 'rgba(255,255,255,0.18)');
    shine.setAttribute('class', 'bead-shine');

    g.appendChild(circle);
    g.appendChild(shine);
    container.appendChild(g);
  }

  function initBeads(): void {
    const tailGroup = document.getElementById('tail-beads') as SVGGElement | null;
    const loopGroup = document.getElementById('loop-beads') as SVGGElement | null;
    if (!tailGroup || !loopGroup) return;

    tailGroup.innerHTML = '';
    loopGroup.innerHTML = '';

    for (let i = 1; i < positions.length; i++) {
      const pos = positions[i]!;
      const container = i < 6 ? tailGroup : loopGroup;
      makeBead(i, pos.x, pos.y, pos.size, pos.type, container);
    }
  }

  // ── Update bead states (called from app.ts via global) ───────

  function updateBeads(activeBeadIndex: number): void {
    // Decade dots
    if (activeBeadIndex >= 6) {
      const decadeIdx = Math.floor((activeBeadIndex - 6) / 11);
      document.querySelectorAll('.dec-dot').forEach((dot, i) => {
        dot.classList.toggle('active', i === decadeIdx);
        dot.classList.toggle('done', i < decadeIdx);
      });
    }

    // Crucifix
    const crucifixGroup = document.getElementById('bead-crucifix');
    crucifixGroup?.classList.toggle('is-active', activeBeadIndex === 0);

    // All bead groups
    document.querySelectorAll<SVGGElement>('.bead-group').forEach(grp => {
      const idx = parseInt(grp.dataset['beadIdx'] ?? '-1');
      const bead = grp.querySelector('.rosary-bead') as SVGCircleElement | null;
      if (!bead) return;

      const isActive = idx === activeBeadIndex && activeBeadIndex >= 0;
      const isPrayed = activeBeadIndex >= 0 && idx >= 0 && idx < activeBeadIndex;

      grp.classList.toggle('is-active', isActive);
      grp.classList.toggle('is-prayed', isPrayed && !isActive);
      grp.classList.toggle('is-upcoming', !isActive && !isPrayed && idx >= 0);

      if (isActive) {
        bead.setAttribute('fill', 'url(#bg-active)');
        bead.setAttribute('filter', 'url(#glow-strong)');
      } else if (isPrayed) {
        bead.setAttribute('fill', 'url(#bg-prayed)');
        bead.removeAttribute('filter');
      } else {
        const isOf = grp.classList.contains('bead-of') || grp.classList.contains('bead-connector');
        bead.setAttribute('fill', isOf ? 'url(#bg-of)' : 'url(#bg-hm)');
        bead.removeAttribute('filter');
      }
    });
  }

  // Expose globally for app.ts
  (window as any).updateBeads = updateBeads;

  initBeads();
</script>

<style>
  .rosary-wrap {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  #rosary-svg {
    width: 100%;
    height: 100%;
    max-height: 100%;
    flex: 1;
    min-height: 0;
    filter: drop-shadow(0 0 40px rgba(0,0,0,0.9));
  }

  /* Bead group states */
  .bead-group {
    transition: opacity 0.4s ease;
    cursor: pointer;
  }

  .bead-group.is-prayed { opacity: 0.45; }
  .bead-group.is-upcoming { opacity: 1; }

  .bead-group.is-active {
    opacity: 1;
    animation: beadBounce 1.6s ease-in-out infinite;
  }

  /* Crucifix active state */
  .bead-crucifix.is-active {
    filter: drop-shadow(0 0 12px var(--gold)) drop-shadow(0 0 28px var(--gold-glow));
    animation: beadBounce 2s ease-in-out infinite;
  }

  @keyframes beadBounce {
    0%, 100% { transform: scale(1.0) translateY(0); }
    50%       { transform: scale(1.14) translateY(-3px); }
  }

  /* Decade track */
  .decade-track {
    display: flex;
    gap: clamp(0.6rem, 3vw, 1.4rem);
    padding: 0.5rem 0.5rem 0.3rem;
    flex-shrink: 0;
  }

  .dec-dot {
    width: clamp(22px, 4vw, 32px);
    height: clamp(22px, 4vw, 32px);
    border-radius: 50%;
    border: 1.5px solid var(--gold-dim);
    background: transparent;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.4s ease;
    position: relative;
  }

  .dec-num {
    font-family: 'Cinzel', serif;
    font-size: clamp(0.6rem, 1.8vw, 0.8rem);
    color: var(--text-muted);
    transition: color 0.3s;
    user-select: none;
  }

  .dec-dot.active {
    background: var(--accent);
    border-color: var(--accent2);
    box-shadow: 0 0 12px var(--accent-glow), 0 0 20px var(--accent-glow);
    transform: scale(1.15);
  }
  .dec-dot.active .dec-num { color: #fff; }

  .dec-dot.done {
    background: var(--gold-dim);
    border-color: transparent;
    opacity: 0.55;
  }
  .dec-dot.done .dec-num { color: var(--bg); }
</style>
